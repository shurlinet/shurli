# Docker Compose topology for Shurli integration tests.
#
# Three containers on a single bridge network:
#   relay  (172.28.0.10)  - circuit relay server, gating disabled for tests
#   node-a (172.28.0.11)  - first peer (inviter / daemon host)
#   node-b (172.28.0.12)  - second peer (joiner / ping client)
#
# All containers start with "sleep infinity" and are fully orchestrated
# by the Go test via "docker exec". The test writes configs, starts
# processes, and verifies results.
#
# Coverage: Binary is built with -cover. GOCOVERDIR tells it where to
# write coverage data. The test collects this data before teardown.

services:
  relay:
    build:
      context: ../..
      dockerfile: test/docker/Dockerfile
      target: relay
    container_name: relay
    environment:
      - GOCOVERDIR=/covdata
    networks:
      shurli-test:
        ipv4_address: 172.28.0.10
    entrypoint: ["sleep", "infinity"]

  node-a:
    build:
      context: ../..
      dockerfile: test/docker/Dockerfile
      target: node
    container_name: node-a
    environment:
      - GOCOVERDIR=/covdata
    networks:
      shurli-test:
        ipv4_address: 172.28.0.11
    entrypoint: ["sleep", "infinity"]

  node-b:
    build:
      context: ../..
      dockerfile: test/docker/Dockerfile
      target: node
    container_name: node-b
    environment:
      - GOCOVERDIR=/covdata
    networks:
      shurli-test:
        ipv4_address: 172.28.0.12
    entrypoint: ["sleep", "infinity"]

networks:
  shurli-test:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
