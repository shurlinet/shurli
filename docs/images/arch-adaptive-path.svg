<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 680" width="900" height="680">
  <defs>
    <linearGradient id="nodeFill" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#2d3561;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#1e2140;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="relayFill" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3b3078;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#251e50;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="greenFill" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#1e3a2f;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#162c24;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="amberFill" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3a2e1e;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2c2216;stop-opacity:1" />
    </linearGradient>
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="900" height="680" rx="12" fill="#0f1117"/>

  <!-- Title -->
  <text x="450" y="30" font-family="system-ui, sans-serif" font-size="15" fill="#c0caf5" text-anchor="middle" font-weight="700">Adaptive Path Selection (Batch I)</text>
  <text x="450" y="48" font-family="SF Mono, monospace" font-size="10" fill="#565f89" text-anchor="middle">6 components working together to find the best path to each peer</text>

  <!-- ═══════════════════════ STARTUP PHASE (left column) ═══════════════════════ -->
  <text x="160" y="80" font-family="system-ui, sans-serif" font-size="12" fill="#bb9af7" text-anchor="middle" font-weight="600">STARTUP</text>
  <line x1="60" y1="88" x2="260" y2="88" stroke="#bb9af7" stroke-width="0.5" opacity="0.4"/>

  <!-- I-a: Interface Discovery -->
  <rect x="30" y="100" width="260" height="72" rx="10" fill="url(#nodeFill)" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="50" y="120" font-family="SF Mono, monospace" font-size="9" fill="#3b82f6" font-weight="700">I-a</text>
  <text x="73" y="120" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" font-weight="600">Interface Discovery</text>
  <text x="160" y="138" font-family="SF Mono, monospace" font-size="10" fill="#a9b1d6" text-anchor="middle">DiscoverInterfaces()</text>
  <text x="160" y="155" font-family="SF Mono, monospace" font-size="9" fill="#565f89" text-anchor="middle">IPv6/IPv4 classification per interface</text>
  <!-- IPv6 badge -->
  <rect x="222" y="157" width="55" height="14" rx="4" fill="#1e3a2f" stroke="#9ece6a" stroke-width="0.8"/>
  <text x="249" y="167" font-family="SF Mono, monospace" font-size="8" fill="#9ece6a" text-anchor="middle">IPv6 ✓</text>

  <!-- Arrow I-a → I-e -->
  <line x1="160" y1="172" x2="160" y2="192" stroke="#7aa2f7" stroke-width="1.2"/>
  <polygon points="155,189 165,189 160,197" fill="#7aa2f7"/>

  <!-- I-e: STUN Prober -->
  <rect x="30" y="198" width="260" height="72" rx="10" fill="url(#nodeFill)" stroke="#e0af68" stroke-width="1.5"/>
  <text x="50" y="218" font-family="SF Mono, monospace" font-size="9" fill="#e0af68" font-weight="700">I-e</text>
  <text x="73" y="218" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" font-weight="600">STUN NAT Detection</text>
  <text x="160" y="236" font-family="SF Mono, monospace" font-size="10" fill="#a9b1d6" text-anchor="middle">STUNProber.Probe()</text>
  <text x="160" y="253" font-family="SF Mono, monospace" font-size="9" fill="#565f89" text-anchor="middle">RFC 5389 - zero dependencies</text>
  <!-- NAT type badge -->
  <rect x="195" y="255" width="82" height="14" rx="4" fill="url(#amberFill)" stroke="#e0af68" stroke-width="0.8"/>
  <text x="236" y="265" font-family="SF Mono, monospace" font-size="8" fill="#e0af68" text-anchor="middle">NAT: restricted</text>

  <!-- Arrow I-e → I-f -->
  <line x1="160" y1="270" x2="160" y2="290" stroke="#7aa2f7" stroke-width="1.2"/>
  <polygon points="155,287 165,287 160,295" fill="#7aa2f7"/>

  <!-- I-f: Peer Relay -->
  <rect x="30" y="296" width="260" height="72" rx="10" fill="url(#nodeFill)" stroke="#9ece6a" stroke-width="1.5"/>
  <text x="50" y="316" font-family="SF Mono, monospace" font-size="9" fill="#9ece6a" font-weight="700">I-f</text>
  <text x="73" y="316" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" font-weight="600">Every-Peer-Is-A-Relay</text>
  <text x="160" y="334" font-family="SF Mono, monospace" font-size="10" fill="#a9b1d6" text-anchor="middle">PeerRelay.AutoDetect()</text>
  <text x="160" y="351" font-family="SF Mono, monospace" font-size="9" fill="#565f89" text-anchor="middle">Public IP? → enable relay v2</text>
  <!-- Relay badge -->
  <rect x="204" y="353" width="73" height="14" rx="4" fill="#1e3a2f" stroke="#9ece6a" stroke-width="0.8"/>
  <text x="240" y="363" font-family="SF Mono, monospace" font-size="8" fill="#9ece6a" text-anchor="middle">relaying: on</text>

  <!-- ═══════════════════════ CONNECTION PHASE (right column) ═══════════════════════ -->
  <text x="610" y="80" font-family="system-ui, sans-serif" font-size="12" fill="#bb9af7" text-anchor="middle" font-weight="600">CONNECTION</text>
  <line x1="440" y1="88" x2="780" y2="88" stroke="#bb9af7" stroke-width="0.5" opacity="0.4"/>

  <!-- I-b: PathDialer -->
  <rect x="420" y="100" width="360" height="105" rx="10" fill="url(#nodeFill)" stroke="#7aa2f7" stroke-width="1.8"/>
  <text x="440" y="120" font-family="SF Mono, monospace" font-size="9" fill="#7aa2f7" font-weight="700">I-b</text>
  <text x="463" y="120" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" font-weight="600">Parallel Dial Racing</text>
  <text x="600" y="138" font-family="SF Mono, monospace" font-size="10" fill="#a9b1d6" text-anchor="middle">PathDialer.DialPeer()</text>

  <!-- Racing lanes inside PathDialer -->
  <!-- Already connected? -->
  <rect x="435" y="148" width="130" height="22" rx="5" fill="#1e3a2f" stroke="#9ece6a" stroke-width="0.8"/>
  <text x="500" y="163" font-family="SF Mono, monospace" font-size="9" fill="#9ece6a" text-anchor="middle">Already connected?</text>

  <!-- DHT lane -->
  <rect x="435" y="175" width="130" height="22" rx="5" fill="url(#relayFill)" stroke="#bb9af7" stroke-width="0.8"/>
  <text x="500" y="190" font-family="SF Mono, monospace" font-size="9" fill="#bb9af7" text-anchor="middle">DHT FindPeer (15s)</text>

  <!-- Relay lane -->
  <rect x="580" y="175" width="130" height="22" rx="5" fill="url(#relayFill)" stroke="#bb9af7" stroke-width="0.8"/>
  <text x="645" y="190" font-family="SF Mono, monospace" font-size="9" fill="#bb9af7" text-anchor="middle">Relay circuit (30s)</text>

  <!-- Parallel symbol between DHT and Relay -->
  <text x="566" y="190" font-family="SF Mono, monospace" font-size="11" fill="#e0af68" text-anchor="middle" font-weight="700">||</text>

  <!-- Arrow from PathDialer to PathTracker -->
  <line x1="600" y1="205" x2="600" y2="228" stroke="#7aa2f7" stroke-width="1.2"/>
  <polygon points="595,225 605,225 600,233" fill="#7aa2f7"/>

  <!-- Winner label -->
  <text x="770" y="144" font-family="SF Mono, monospace" font-size="9" fill="#9ece6a" text-anchor="end">fastest wins</text>
  <text x="770" y="156" font-family="SF Mono, monospace" font-size="9" fill="#565f89" text-anchor="end">loser cancelled</text>

  <!-- I-c: PathTracker -->
  <rect x="420" y="234" width="360" height="80" rx="10" fill="url(#nodeFill)" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="440" y="254" font-family="SF Mono, monospace" font-size="9" fill="#3b82f6" font-weight="700">I-c</text>
  <text x="463" y="254" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" font-weight="600">Path Quality Tracking</text>
  <text x="600" y="272" font-family="SF Mono, monospace" font-size="10" fill="#a9b1d6" text-anchor="middle">PathTracker (event-bus)</text>

  <!-- Per-peer info cards -->
  <rect x="435" y="280" width="100" height="28" rx="4" fill="#1a1e36" stroke="#565f89" stroke-width="0.7"/>
  <text x="485" y="292" font-family="SF Mono, monospace" font-size="8" fill="#9ece6a" text-anchor="middle">DIRECT</text>
  <text x="485" y="303" font-family="SF Mono, monospace" font-size="7" fill="#565f89" text-anchor="middle">quic - ipv6 - 12ms</text>

  <rect x="545" y="280" width="100" height="28" rx="4" fill="#1a1e36" stroke="#565f89" stroke-width="0.7"/>
  <text x="595" y="292" font-family="SF Mono, monospace" font-size="8" fill="#e0af68" text-anchor="middle">RELAYED</text>
  <text x="595" y="303" font-family="SF Mono, monospace" font-size="7" fill="#565f89" text-anchor="middle">tcp - ipv4 - 85ms</text>

  <rect x="655" y="280" width="100" height="28" rx="4" fill="#1a1e36" stroke="#565f89" stroke-width="0.7"/>
  <text x="705" y="292" font-family="SF Mono, monospace" font-size="8" fill="#9ece6a" text-anchor="middle">DIRECT</text>
  <text x="705" y="303" font-family="SF Mono, monospace" font-size="7" fill="#565f89" text-anchor="middle">quic - ipv4 - 34ms</text>

  <!-- ═══════════════════════ MONITORING PHASE (bottom, full width) ═══════════════════════ -->
  <text x="450" y="395" font-family="system-ui, sans-serif" font-size="12" fill="#bb9af7" text-anchor="middle" font-weight="600">CONTINUOUS MONITORING</text>
  <line x1="60" y1="403" x2="840" y2="403" stroke="#bb9af7" stroke-width="0.5" opacity="0.4"/>

  <!-- I-d: Network Monitor -->
  <rect x="130" y="415" width="640" height="68" rx="10" fill="url(#nodeFill)" stroke="#f7768e" stroke-width="1.5"/>
  <text x="150" y="435" font-family="SF Mono, monospace" font-size="9" fill="#f7768e" font-weight="700">I-d</text>
  <text x="173" y="435" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" font-weight="600">Network Change Monitor</text>
  <text x="450" y="453" font-family="SF Mono, monospace" font-size="10" fill="#a9b1d6" text-anchor="middle">NetworkMonitor.Run() - event-driven interface/address change detection</text>

  <!-- Trigger arrows from monitor back to components -->
  <!-- Arrow to I-a (re-scan) -->
  <text x="205" y="475" font-family="SF Mono, monospace" font-size="8" fill="#f7768e">re-scan interfaces</text>
  <!-- Arrow to I-e (re-probe STUN) -->
  <text x="378" y="475" font-family="SF Mono, monospace" font-size="8" fill="#f7768e">re-probe STUN</text>
  <!-- Arrow to I-f (update relay) -->
  <text x="560" y="475" font-family="SF Mono, monospace" font-size="8" fill="#f7768e">update peer relay</text>

  <!-- Upward callback arrows from monitor -->
  <line x1="230" y1="415" x2="160" y2="370" stroke="#f7768e" stroke-width="1" stroke-dasharray="4,3" opacity="0.6"/>
  <polygon points="157,373 163,373 160,367" fill="#f7768e" opacity="0.6"/>

  <line x1="420" y1="415" x2="160" y2="272" stroke="#f7768e" stroke-width="1" stroke-dasharray="4,3" opacity="0.6"/>
  <polygon points="157,275 163,275 160,269" fill="#f7768e" opacity="0.6"/>

  <line x1="620" y1="415" x2="250" y2="345" stroke="#f7768e" stroke-width="1" stroke-dasharray="4,3" opacity="0.6"/>
  <polygon points="247,348 253,348 250,342" fill="#f7768e" opacity="0.6"/>

  <!-- ═══════════════════════ PATH RANKING (bottom) ═══════════════════════ -->
  <text x="450" y="520" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" text-anchor="middle" font-weight="600">Path Ranking (best to worst)</text>

  <!-- Ranking bars -->
  <!-- 1: Direct IPv6 -->
  <rect x="80" y="535" width="190" height="28" rx="6" fill="#1e3a2f" stroke="#9ece6a" stroke-width="1.5"/>
  <text x="90" y="553" font-family="SF Mono, monospace" font-size="9" fill="#9ece6a" font-weight="700">1</text>
  <text x="105" y="553" font-family="SF Mono, monospace" font-size="10" fill="#9ece6a">Direct IPv6</text>
  <text x="260" y="553" font-family="SF Mono, monospace" font-size="8" fill="#565f89" text-anchor="end">no NAT</text>

  <!-- 2: Direct IPv4 -->
  <rect x="290" y="535" width="190" height="28" rx="6" fill="#1e3a2f" stroke="#9ece6a" stroke-width="1.2" opacity="0.8"/>
  <text x="300" y="553" font-family="SF Mono, monospace" font-size="9" fill="#9ece6a" font-weight="700">2</text>
  <text x="315" y="553" font-family="SF Mono, monospace" font-size="10" fill="#9ece6a" opacity="0.8">Direct IPv4</text>
  <text x="470" y="553" font-family="SF Mono, monospace" font-size="8" fill="#565f89" text-anchor="end">hole-punched</text>

  <!-- 3: Peer Relay -->
  <rect x="500" y="535" width="190" height="28" rx="6" fill="url(#amberFill)" stroke="#e0af68" stroke-width="1.2"/>
  <text x="510" y="553" font-family="SF Mono, monospace" font-size="9" fill="#e0af68" font-weight="700">3</text>
  <text x="525" y="553" font-family="SF Mono, monospace" font-size="10" fill="#e0af68">Peer Relay</text>
  <text x="680" y="553" font-family="SF Mono, monospace" font-size="8" fill="#565f89" text-anchor="end">authorized peer</text>

  <!-- 4: VPS Relay -->
  <rect x="710" y="535" width="120" height="28" rx="6" fill="url(#amberFill)" stroke="#f7768e" stroke-width="1.2" opacity="0.7"/>
  <text x="720" y="553" font-family="SF Mono, monospace" font-size="9" fill="#f7768e" font-weight="700">4</text>
  <text x="735" y="553" font-family="SF Mono, monospace" font-size="10" fill="#f7768e" opacity="0.8">VPS Relay</text>

  <!-- Arrows between ranking levels -->
  <text x="278" y="553" font-family="system-ui, sans-serif" font-size="12" fill="#565f89">></text>
  <text x="488" y="553" font-family="system-ui, sans-serif" font-size="12" fill="#565f89">></text>
  <text x="698" y="553" font-family="system-ui, sans-serif" font-size="12" fill="#565f89">></text>

  <!-- ═══════════════════════ DAEMON API EXPOSURE ═══════════════════════ -->
  <rect x="130" y="585" width="640" height="38" rx="8" fill="#1a1e36" stroke="#565f89" stroke-width="0.8"/>
  <text x="450" y="601" font-family="SF Mono, monospace" font-size="10" fill="#a9b1d6" text-anchor="middle">Daemon API</text>
  <text x="220" y="616" font-family="SF Mono, monospace" font-size="8" fill="#565f89" text-anchor="middle">GET /v1/status</text>
  <text x="350" y="616" font-family="SF Mono, monospace" font-size="8" fill="#565f89" text-anchor="middle">GET /v1/paths</text>
  <text x="480" y="616" font-family="SF Mono, monospace" font-size="8" fill="#565f89" text-anchor="middle">nat_type</text>
  <text x="580" y="616" font-family="SF Mono, monospace" font-size="8" fill="#565f89" text-anchor="middle">is_relaying</text>
  <text x="680" y="616" font-family="SF Mono, monospace" font-size="8" fill="#565f89" text-anchor="middle">has_global_ipv6</text>

  <!-- ═══════════════════════ LEGEND ═══════════════════════ -->
  <rect x="175" y="640" width="8" height="8" rx="2" fill="url(#nodeFill)" stroke="#3b82f6" stroke-width="1"/>
  <text x="190" y="648" font-family="system-ui, sans-serif" font-size="9" fill="#a9b1d6">Discovery / Tracking</text>

  <rect x="318" y="640" width="8" height="8" rx="2" fill="url(#nodeFill)" stroke="#e0af68" stroke-width="1"/>
  <text x="333" y="648" font-family="system-ui, sans-serif" font-size="9" fill="#a9b1d6">STUN Probing</text>

  <rect x="428" y="640" width="8" height="8" rx="2" fill="url(#nodeFill)" stroke="#9ece6a" stroke-width="1"/>
  <text x="443" y="648" font-family="system-ui, sans-serif" font-size="9" fill="#a9b1d6">Peer Relay</text>

  <rect x="528" y="640" width="8" height="8" rx="2" fill="url(#nodeFill)" stroke="#7aa2f7" stroke-width="1"/>
  <text x="543" y="648" font-family="system-ui, sans-serif" font-size="9" fill="#a9b1d6">Dial Racing</text>

  <line x1="638" y1="644" x2="660" y2="644" stroke="#f7768e" stroke-width="1" stroke-dasharray="4,3" opacity="0.6"/>
  <text x="668" y="648" font-family="system-ui, sans-serif" font-size="9" fill="#a9b1d6">Network change trigger</text>

  <!-- Cross-connection: I-a feeds into I-b -->
  <line x1="290" y1="136" x2="420" y2="136" stroke="#565f89" stroke-width="1" stroke-dasharray="4,3" opacity="0.4"/>
  <polygon points="417,131 417,141 423,136" fill="#565f89" opacity="0.4"/>
  <text x="355" y="130" font-family="SF Mono, monospace" font-size="7" fill="#565f89" text-anchor="middle">InterfaceSummary</text>

  <!-- Cross-connection: I-b result feeds I-c -->
  <!-- already shown with the vertical arrow -->

  <!-- Cross-connection: I-e feeds into I-b context -->
  <line x1="290" y1="234" x2="420" y2="200" stroke="#565f89" stroke-width="1" stroke-dasharray="4,3" opacity="0.4"/>
  <polygon points="417,197 418,204 424,200" fill="#565f89" opacity="0.4"/>
  <text x="360" y="210" font-family="SF Mono, monospace" font-size="7" fill="#565f89" text-anchor="middle" transform="rotate(-12, 360, 210)">NATType</text>
</svg>
