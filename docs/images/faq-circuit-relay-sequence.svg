<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 400" width="800" height="400">
  <defs>
    <linearGradient id="peerFill" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#2c2a2e;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#1e1d20;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="relayFill" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#38353b;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2a282c;stop-opacity:1" />
    </linearGradient>
    <filter id="glow">
      <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="800" height="400" rx="12" fill="#141316"/>

  <!-- Title -->
  <text x="400" y="28" font-family="system-ui, sans-serif" font-size="14" fill="#c0caf5" text-anchor="middle" font-weight="600">Circuit Relay v2 - Connection Sequence</text>

  <!-- Peer A header -->
  <rect x="60" y="45" width="120" height="36" rx="8" fill="url(#peerFill)" stroke="#da1c5c" stroke-width="1.3"/>
  <text x="120" y="67" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" text-anchor="middle" font-weight="600">Peer A</text>

  <!-- Relay header -->
  <rect x="340" y="45" width="120" height="36" rx="8" fill="url(#relayFill)" stroke="#bb9af7" stroke-width="1.3"/>
  <text x="400" y="67" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" text-anchor="middle" font-weight="600">Relay</text>

  <!-- Peer B header -->
  <rect x="620" y="45" width="120" height="36" rx="8" fill="url(#peerFill)" stroke="#da1c5c" stroke-width="1.3"/>
  <text x="680" y="67" font-family="system-ui, sans-serif" font-size="12" fill="#c0caf5" text-anchor="middle" font-weight="600">Peer B</text>

  <!-- Vertical lifelines -->
  <line x1="120" y1="81" x2="120" y2="370" stroke="#565f89" stroke-width="1" stroke-dasharray="4,3" opacity="0.4"/>
  <line x1="400" y1="81" x2="400" y2="370" stroke="#565f89" stroke-width="1" stroke-dasharray="4,3" opacity="0.4"/>
  <line x1="680" y1="81" x2="680" y2="370" stroke="#565f89" stroke-width="1" stroke-dasharray="4,3" opacity="0.4"/>

  <!-- Step 1: A → Relay: RESERVE -->
  <line x1="120" y1="110" x2="400" y2="110" stroke="#e8729a" stroke-width="2" filter="url(#glow)"/>
  <polygon points="395,105 395,115 404,110" fill="#e8729a"/>
  <text x="260" y="103" font-family="SF Mono, monospace" font-size="10" fill="#e8729a" text-anchor="middle" font-weight="600">1. RESERVE</text>
  <text x="40" y="114" font-family="SF Mono, monospace" font-size="9" fill="#bb9af7">hop</text>

  <!-- Step 2: Relay → A: OK + voucher -->
  <line x1="400" y1="150" x2="120" y2="150" stroke="#9ece6a" stroke-width="2" filter="url(#glow)"/>
  <polygon points="125,145 125,155 116,150" fill="#9ece6a"/>
  <text x="260" y="143" font-family="SF Mono, monospace" font-size="10" fill="#9ece6a" text-anchor="middle" font-weight="600">2. OK + expiration + voucher</text>

  <!-- Step 3: B → Relay: CONNECT to A -->
  <line x1="680" y1="195" x2="400" y2="195" stroke="#e8729a" stroke-width="2" filter="url(#glow)"/>
  <polygon points="405,190 405,200 396,195" fill="#e8729a"/>
  <text x="540" y="188" font-family="SF Mono, monospace" font-size="10" fill="#e8729a" text-anchor="middle" font-weight="600">3. CONNECT to A</text>
  <text x="760" y="199" font-family="SF Mono, monospace" font-size="9" fill="#bb9af7">hop</text>

  <!-- Step 4: Relay → A: B wants to connect -->
  <line x1="400" y1="235" x2="120" y2="235" stroke="#e0af68" stroke-width="2" filter="url(#glow)"/>
  <polygon points="125,230 125,240 116,235" fill="#e0af68"/>
  <text x="260" y="228" font-family="SF Mono, monospace" font-size="10" fill="#e0af68" text-anchor="middle" font-weight="600">4. "B wants to connect"</text>
  <text x="40" y="239" font-family="SF Mono, monospace" font-size="9" fill="#bb9af7">stop</text>

  <!-- Step 5: A → Relay: OK -->
  <line x1="120" y1="275" x2="400" y2="275" stroke="#9ece6a" stroke-width="2" filter="url(#glow)"/>
  <polygon points="395,270 395,280 404,275" fill="#9ece6a"/>
  <text x="260" y="268" font-family="SF Mono, monospace" font-size="10" fill="#9ece6a" text-anchor="middle" font-weight="600">5. OK</text>

  <!-- Step 6: Bridge (bidirectional) -->
  <rect x="115" y="310" width="570" height="30" rx="6" fill="#1e1d20" stroke="#e8729a" stroke-width="1" opacity="0.6"/>
  <line x1="120" y1="325" x2="680" y2="325" stroke="#e8729a" stroke-width="2.5" filter="url(#glow)"/>
  <!-- Bidirectional arrows -->
  <polygon points="674,320 674,330 683,325" fill="#e8729a"/>
  <polygon points="126,320 126,330 117,325" fill="#e8729a"/>
  <text x="400" y="322" font-family="SF Mono, monospace" font-size="10" fill="#e8729a" text-anchor="middle" font-weight="600">6. Relay bridges streams - data flows bidirectionally</text>

  <!-- Protocol labels -->
  <text x="400" y="362" font-family="SF Mono, monospace" font-size="9" fill="#565f89" text-anchor="middle">
    hop: /libp2p/circuit/relay/0.2.0/hop · stop: /libp2p/circuit/relay/0.2.0/stop
  </text>

  <!-- End-to-end encryption note -->
  <text x="400" y="385" font-family="system-ui, sans-serif" font-size="10" fill="#9ece6a" text-anchor="middle" opacity="0.7">
    End-to-end encrypted (Noise protocol) - relay sees ciphertext only
  </text>
</svg>
